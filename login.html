<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius - Login</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="styles.css">
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">Genius</h1>
                <p class="login-subtitle">Class Management System</p>
            </div>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter your password (min 6 characters)" required>
                </div>
                
                <button id="loginBtn" class="login-btn">Sign In</button>
                <button id="signupBtn" class="signup-btn">Create Account</button>
                
                <div class="login-divider">
                    <span>or</span>
                </div>
                
                <button id="googleBtn" class="google-btn">
                    <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 10px;">
                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18z"/>
                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
            
            <div class="login-footer">
                <p>Welcome to your class management dashboard</p>
            </div>
        </div>
    </div>

    <script>
        // Wait for Firebase to initialize
        let auth, googleProvider;
        
        async function initLogin() {
            try {
                console.log('Waiting for Firebase to load...');
                
                // Wait for Firebase to be available
                while (!window.firebase) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // Initialize Firebase
                const firebaseConfig = {
                    apiKey: "AIzaSyB-JPtkbuIES5T_m7nkX0Ic1iO_lz0FbTk",
                    authDomain: "genius-b5656.firebaseapp.com",
                    projectId: "genius-b5656",
                    storageBucket: "genius-b5656.firebasestorage.app",
                    messagingSenderId: "567988128391",
                    appId: "1:567988128391:web:8a48294d736ec4013f8622",
                    measurementId: "G-3SEG2XJQMP"
                };
                
                // Initialize Firebase
                window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.auth();
                googleProvider = new window.firebase.auth.GoogleAuthProvider();
                
                // Firebase functions will be called directly from window.firebase.auth()
                
                console.log('Firebase initialized successfully');
                console.log('Auth object:', auth);
                console.log('Google provider:', googleProvider);
                
                // Initialize the login functionality
                initializeLogin();
                
            } catch (error) {
                console.error('Error initializing Firebase:', error);
                alert('Failed to load Firebase. Please refresh the page.');
            }
        }
        
        // Function to check onboarding status and redirect appropriately
        async function checkOnboardingAndRedirect(userId) {
            try {
                // First check localStorage for quick access
                const onboardingComplete = localStorage.getItem(`onboarding_${userId}`);
                if (onboardingComplete) {
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                // Check Firebase for more reliable data
                const userProfileRef = window.firebase.firestore().collection('users').doc(userId);
                const userProfileDoc = await userProfileRef.get();
                
                if (userProfileDoc.exists) {
                    const userData = userProfileDoc.data();
                    
                    // Check if onboarding is marked as complete
                    if (userData.onboardingComplete) {
                        console.log('User has completed onboarding, redirecting to dashboard');
                        window.location.href = 'dashboard.html';
                        return;
                    }
                    
                    // Check if user has basic profile data (name, email, etc.)
                    if (userData.name && userData.email && userData.collegeName) {
                        console.log('User has existing profile data, marking onboarding complete and redirecting to dashboard');
                        // Mark onboarding as complete and redirect
                        await userProfileRef.update({
                            onboardingComplete: true,
                            lastLogin: new Date().toISOString()
                        });
                        window.location.href = 'dashboard.html';
                        return;
                    }
                }
                
                // Check localStorage for existing profile data
                const existingProfile = localStorage.getItem('userData');
                if (existingProfile) {
                    const profileData = JSON.parse(existingProfile);
                    if (profileData.name && profileData.email && profileData.collegeName) {
                        console.log('User has existing profile data in localStorage, redirecting to dashboard');
                        // Save to Firebase and mark onboarding complete
                        await window.firebase.firestore().collection('users').doc(userId).set({
                            ...profileData,
                            onboardingComplete: true,
                            lastLogin: new Date().toISOString()
                        }, { merge: true });
                        window.location.href = 'dashboard.html';
                        return;
                    }
                }
                
                // If no existing data found, redirect to onboarding
                console.log('User needs to complete onboarding');
                window.location.href = 'onboarding.html';
                
            } catch (error) {
                console.error('Error checking onboarding status:', error);
                // If there's an error, redirect to onboarding to be safe
                window.location.href = 'onboarding.html';
            }
        }

        function initializeLogin() {
            // Check if user is already logged in
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                const userData = JSON.parse(currentUser);
                checkOnboardingAndRedirect(userData.uid);
            }

        // Login button
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            // Disable button and show loading
            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';

            try {
                console.log('Attempting login with:', email);
                const userCredential = await window.firebase.auth().signInWithEmailAndPassword(email, password);
                console.log('Login successful:', userCredential.user.uid);
                
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: userCredential.user.uid,
                    email: userCredential.user.email
                }));
                
                // Check if onboarding completed
                await checkOnboardingAndRedirect(userCredential.user.uid);
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        // Signup button
        document.getElementById('signupBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const signupBtn = document.getElementById('signupBtn');

            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }

            if (password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            // Disable button and show loading
            signupBtn.disabled = true;
            signupBtn.textContent = 'Creating account...';

            try {
                console.log('Attempting signup with:', email);
                const userCredential = await window.firebase.auth().createUserWithEmailAndPassword(email, password);
                console.log('Signup successful:', userCredential.user.uid);
                
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: userCredential.user.uid,
                    email: userCredential.user.email
                }));
                
                console.log('Redirecting to onboarding...');
                window.location.href = 'onboarding.html';
            } catch (error) {
                console.error('Signup error:', error);
                let errorMessage = error.message;
                
                // Provide more user-friendly error messages
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Please sign in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Please enter a valid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Please use at least 6 characters.';
                }
                
                alert('Signup failed: ' + errorMessage);
                signupBtn.disabled = false;
                signupBtn.textContent = 'Create Account';
            }
        });

        // Google sign-in button
        document.getElementById('googleBtn').addEventListener('click', async () => {
            const googleBtn = document.getElementById('googleBtn');
            
            // Disable button and show loading
            googleBtn.disabled = true;
            googleBtn.innerHTML = '<span style="margin-right: 10px;">⏳</span> Signing in...';
            
            try {
                console.log('Attempting Google sign-in...');
                const result = await window.firebase.auth().signInWithPopup(googleProvider);
                const user = result.user;
                
                console.log('Google sign-in successful:', user.uid);
                
                localStorage.setItem('currentUser', JSON.stringify({
                    uid: user.uid,
                    email: user.email,
                    displayName: user.displayName,
                    photoURL: user.photoURL
                }));
                
                // Check if onboarding completed
                await checkOnboardingAndRedirect(user.uid);
            } catch (error) {
                console.error('Google sign-in error:', error);
                let errorMessage = error.message;
                
                // Provide more user-friendly error messages
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Sign-in cancelled. Please try again.';
                } else if (error.code === 'auth/popup-blocked') {
                    errorMessage = 'Pop-up blocked. Please allow pop-ups for this site.';
                }
                
                alert('Google sign-in failed: ' + errorMessage);
                googleBtn.disabled = false;
                googleBtn.innerHTML = `
                    <svg width="18" height="18" viewBox="0 0 18 18" style="margin-right: 10px;">
                        <path fill="#4285F4" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#34A853" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#FBBC05" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18z"/>
                        <path fill="#EA4335" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Sign in with Google
                `;
            }
        });
        }
        
        // Initialize the login page
        initLogin();
    </script>
</body>
</html>

