<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genius - Choose Your Plan</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="/icon-512.png">
    
    <!-- Vercel Analytics -->
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script>
        // Only load Vercel Analytics on Vercel deployment
        if (window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.com') || window.location.hostname.includes('genius-site.com')) {
            const script = document.createElement('script');
            script.src = '/_vercel/insights/script.js';
            script.defer = true;
            document.head.appendChild(script);
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #000000, #1a1a1a);
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .subscription-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
        }

        .logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background-image: url('assets/darkgenius.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }

        .subtitle {
            color: #cccccc;
            margin-bottom: 40px;
            font-size: 18px;
            line-height: 1.5;
        }

        .features-section {
            margin-bottom: 50px;
        }

        .features-section h2 {
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }

        .flashcard-container {
            display: flex;
            justify-content: center;
            margin: 0 auto;
            max-width: 600px;
            perspective: 1000px;
        }

        .flashcard {
            width: 100%;
            max-width: 500px;
            height: 300px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            animation: slideInFromBottom 0.8s ease-out;
        }

        .flashcard.flipped {
            transform: rotateY(180deg);
        }

        .flashcard.new-card {
            animation: dragFromBottom 0.8s ease-out;
        }

        .flashcard.swipe-out {
            animation: swipeOutRight 0.6s ease-in;
        }

        @keyframes swipeOutRight {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(100px) scale(0.8);
            }
        }

        .flashcard-content {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
        }

        .flashcard-front,
        .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .flashcard-front {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .flashcard-back {
            background: linear-gradient(145deg, #1a1a2a, #2a2a3a);
            border: 1px solid rgba(74, 158, 255, 0.3);
            transform: rotateY(180deg);
        }

        .flashcard-question,
        .flashcard-answer {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            line-height: 1.5;
            max-width: 100%;
            animation: fadeInUp 0.5s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .flashcard {
            animation: slideInFromBottom 0.6s ease-out;
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(100px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes dragFromBottom {
            0% {
                opacity: 0;
                transform: translateY(150px) scale(0.7) rotateX(15deg);
            }
            50% {
                opacity: 0.7;
                transform: translateY(50px) scale(0.9) rotateX(5deg);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1) rotateX(0deg);
            }
        }

        .flashcard.flipped .flashcard-back {
            animation: flipIn 0.6s ease-in-out;
        }

        @keyframes flipIn {
            from {
                opacity: 0;
                transform: rotateY(90deg);
            }
            to {
                opacity: 1;
                transform: rotateY(180deg);
            }
        }


        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .pricing-section {
            margin-bottom: 40px;
        }

        .pricing-section h2 {
            color: #ffffff;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
        }

        .pricing-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .pricing-btn {
            flex: 1;
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .pricing-btn:hover {
            transform: translateY(-3px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .pricing-btn.selected {
            border-color: #4a9eff;
            background: linear-gradient(145deg, #1a1a2a, #2a2a3a);
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }

        .pricing-btn.popular {
            border-color: #4a9eff;
            background: linear-gradient(145deg, #1a1a2a, #2a2a3a);
        }

        .pricing-btn.popular::before {
            content: 'Most Popular';
            position: absolute;
            top: 15px;
            right: -25px;
            background: #4a9eff;
            color: white;
            padding: 4px 30px;
            font-size: 11px;
            font-weight: 600;
            transform: rotate(45deg);
        }

        .pricing-btn.selected {
            border-color: #4a9eff;
            background: linear-gradient(145deg, #1a1a2a, #2a2a3a);
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.3);
        }

        .pricing-info {
            text-align: center;
        }

        .plan-name {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 2px;
        }

        .plan-price {
            font-size: 24px;
            font-weight: 700;
            color: #4a9eff;
            margin-bottom: 1px;
        }

        .plan-period {
            color: #888888;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .plan-savings {
            background: rgba(74, 158, 255, 0.1);
            color: #4a9eff;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            display: inline-block;
        }

        .error-message {
            background: rgba(244, 67, 54, 0.1);
            color: #ff6b6b;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }

        .success-message {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            padding: 10px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header Bar */
        .header-bar {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-spacer {
            flex: 1;
        }

        .coupon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .coupon-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* Coupon Modal */
        .coupon-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .coupon-modal.show {
            opacity: 1;
        }

        .coupon-modal-content {
            background: linear-gradient(145deg, #1a1a1a, #2a2a2a);
            border-radius: 16px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .coupon-modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .coupon-modal-header h3 {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .close-coupon-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-coupon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .coupon-modal-body {
            padding: 20px 24px 24px;
        }

        .coupon-modal-body p {
            color: #ccc;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .coupon-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .coupon-input-group input {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .coupon-input-group input:focus {
            outline: none;
            border-color: #4a9eff;
            background: rgba(255, 255, 255, 0.1);
        }

        .coupon-input-group input::placeholder {
            color: #666;
        }

        .apply-coupon-btn {
            background: linear-gradient(135deg, #4a9eff, #357abd);
            border: none;
            border-radius: 8px;
            color: #ffffff;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .apply-coupon-btn:hover {
            background: linear-gradient(135deg, #357abd, #2a5f8f);
            transform: translateY(-1px);
        }

        .apply-coupon-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .coupon-message {
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .coupon-message.success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .coupon-message.error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid rgba(244, 67, 54, 0.3);
            color: #f44336;
        }

        @media (max-width: 768px) {
            .plans-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .plan-card {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .plan-price {
                font-size: 36px;
            }

            .header-bar {
                top: 15px;
                right: 15px;
            }

            .coupon-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .coupon-modal-content {
                width: 95%;
                margin: 20px;
            }
        }
    </style>
</head>
<body>

    <div class="subscription-container screen-container">
        <div class="header-bar">
            <div class="header-spacer"></div>
            <button class="coupon-btn" id="couponBtn">
                <span>üéüÔ∏è</span> Coupon
            </button>
        </div>
        
        <div class="logo"></div>
        <div class="logo-text">Genius</div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>

        <!-- Pricing Section -->
        <div class="pricing-section">
            <div class="pricing-buttons">
                <button class="pricing-btn" id="monthlyBtn" onclick="selectPlan('monthly')">
                    <div class="pricing-info">
                        <div class="plan-name">Monthly</div>
                        <div class="plan-price">$15</div>
                        <div class="plan-period">per month</div>
                    </div>
                </button>
                
                <button class="pricing-btn popular" id="yearlyBtn" onclick="selectPlan('yearly')">
                    <div class="pricing-info">
                        <div class="plan-name">Yearly</div>
                        <div class="plan-price">$120</div>
                        <div class="plan-period">per year</div>
                        <div class="plan-savings">Save 33%</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Features Section -->
        <div class="features-section">
            <div class="flashcard-container">
                <div class="flashcard" id="flashcard">
                    <div class="flashcard-content">
                        <div class="flashcard-front">
                            <div class="flashcard-question" id="flashcardQuestion"></div>
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-answer" id="flashcardAnswer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Processing your subscription...</p>
        </div>
    </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="coupon-modal">
        <div class="coupon-modal-content">
            <div class="coupon-modal-header">
                <h3>üéüÔ∏è Enter Coupon Code</h3>
                <button id="closeCouponModal" class="close-coupon-btn">√ó</button>
            </div>
            <div class="coupon-modal-body">
                <p>Enter your coupon code to get a discount on your subscription:</p>
                <div class="coupon-input-group">
                    <input type="text" id="couponCode" placeholder="Enter coupon code" maxlength="20">
                    <button id="applyCouponBtn" class="apply-coupon-btn">Apply</button>
                </div>
                <div id="couponMessage" class="coupon-message" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB-JPtkbuIES5T_m7nkX0Ic1iO_lz0FbTk",
            authDomain: "genius-b5656.firebaseapp.com",
            projectId: "genius-b5656",
            storageBucket: "genius-b5656.firebasestorage.app",
            messagingSenderId: "567988128391",
            appId: "1:567988128391:web:8a48294d736ec4013f8622",
            measurementId: "G-3SEG2XJQMP"
        };

        // Initialize Firebase
        let app, auth, db;
        let currentUser = null;
        let stripe = null;
        
        function initFirebase() {
            try {
                app = window.firebase.initializeApp(firebaseConfig);
                auth = window.firebase.auth();
                db = window.firebase.firestore();
                
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                showError('Failed to initialize authentication. Please refresh the page.');
                return false;
            }
        }

        // Initialize Stripe
        function initStripe() {
            try {
                stripe = Stripe('pk_live_51SEIs1RyN1JZ733WSrAqTs40oWPn5n6mXVWANmWBRKawz8xNEv5mPjKYU13ouJK0J3Btux5pZk9eBEcctYqAPv0V0052EsT8ni');
                console.log('Stripe initialized successfully');
                return true;
            } catch (error) {
                console.error('Stripe initialization error:', error);
                showError('Failed to initialize payment system. Please refresh the page.');
                return false;
            }
        }

        // UI Helper functions
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            successDiv.style.display = 'none';
        }

        function showSuccess(message) {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function setLoading(loading) {
            const loadingDiv = document.getElementById('loading');
            const monthlyBtn = document.getElementById('monthlyBtn');
            const yearlyBtn = document.getElementById('yearlyBtn');
            
            if (loading) {
                loadingDiv.style.display = 'block';
                if (monthlyBtn) monthlyBtn.disabled = true;
                if (yearlyBtn) yearlyBtn.disabled = true;
            } else {
                loadingDiv.style.display = 'none';
                if (monthlyBtn) monthlyBtn.disabled = false;
                if (yearlyBtn) yearlyBtn.disabled = false;
            }
        }

        // Coupon functionality
        let appliedCoupon = null;

        function openCouponModal() {
            const modal = document.getElementById('couponModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('couponCode').focus();
            }, 100);
        }

        function closeCouponModal() {
            const modal = document.getElementById('couponModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function showCouponMessage(message, isSuccess = false) {
            const messageDiv = document.getElementById('couponMessage');
            messageDiv.textContent = message;
            messageDiv.className = `coupon-message ${isSuccess ? 'success' : 'error'}`;
            messageDiv.style.display = 'block';
        }

        function hideCouponMessage() {
            const messageDiv = document.getElementById('couponMessage');
            messageDiv.style.display = 'none';
        }

        function applyCoupon() {
            const couponCode = document.getElementById('couponCode').value.trim().toUpperCase();
            const applyBtn = document.getElementById('applyCouponBtn');
            
            if (!couponCode) {
                showCouponMessage('Please enter a coupon code');
                return;
            }

            // Disable button while processing
            applyBtn.disabled = true;
            applyBtn.textContent = 'Applying...';

            // Simulate coupon validation (in real app, this would call your API)
            setTimeout(() => {
                if (couponCode === 'FREEMO') {
                    appliedCoupon = {
                        code: 'promo_1SKsg6RyN1JZ733Wy3jB7gPe', // Use the actual promotion code ID from Stripe
                        promotionCode: couponCode, // Keep the promotion code for display
                        discount: 100,
                        description: '100% off forever'
                    };
                    showCouponMessage(`‚úÖ Coupon "${couponCode}" applied! You'll get 100% off forever!`, true);
                    
                    // Update pricing display
                    updatePricingWithCoupon();
                    
                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeCouponModal();
                    }, 2000);
                } else {
                    showCouponMessage(`‚ùå Invalid coupon code "${couponCode}". Please try again.`);
                }
                
                // Re-enable button
                applyBtn.disabled = false;
                applyBtn.textContent = 'Apply';
            }, 1000);
        }

        function updatePricingWithCoupon() {
            if (!appliedCoupon) return;

            const monthlyBtn = document.getElementById('monthlyBtn');
            const yearlyBtn = document.getElementById('yearlyBtn');
            
            // Update monthly pricing
            const monthlyPrice = monthlyBtn.querySelector('.plan-price');
            const monthlyPeriod = monthlyBtn.querySelector('.plan-period');
            monthlyPrice.textContent = 'FREE';
            monthlyPeriod.textContent = 'forever';
            
            // Update yearly pricing
            const yearlyPrice = yearlyBtn.querySelector('.plan-price');
            const yearlyPeriod = yearlyBtn.querySelector('.plan-period');
            yearlyPrice.textContent = 'FREE';
            yearlyPeriod.textContent = 'forever';
            
            // Add coupon indicator
            const couponIndicator = document.createElement('div');
            couponIndicator.className = 'coupon-applied';
            couponIndicator.innerHTML = `üéüÔ∏è ${appliedCoupon.promotionCode || appliedCoupon.code} applied`;
            couponIndicator.style.cssText = `
                position: absolute;
                top: -10px;
                right: -10px;
                background: #4caf50;
                color: white;
                padding: 4px 8px;
                border-radius: 12px;
                font-size: 10px;
                font-weight: 600;
                z-index: 10;
            `;
            
            monthlyBtn.style.position = 'relative';
            yearlyBtn.style.position = 'relative';
            monthlyBtn.appendChild(couponIndicator.cloneNode(true));
            yearlyBtn.appendChild(couponIndicator.cloneNode(true));
        }

        // Plan selection
        function selectPlan(planType) {
            hideMessages();
            
            // Update visual selection
            document.querySelectorAll('.pricing-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            const selectedBtn = document.getElementById(planType + 'Btn');
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Process subscription
            processSubscription(planType);
        }

        // Process subscription with Stripe
        async function processSubscription(planType) {
            if (!currentUser) {
                showError('Please log in to continue');
                return;
            }

            setLoading(true);

            try {
                // Create checkout session
                const response = await fetch('/api/stripe?action=create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: currentUser.uid,
                        planType: planType,
                        userEmail: currentUser.email,
                        couponCode: appliedCoupon ? appliedCoupon.code : null
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to create checkout session');
                }

                const { sessionId } = await response.json();

                // Redirect to Stripe Checkout
                const { error } = await stripe.redirectToCheckout({
                    sessionId: sessionId
                });

                if (error) {
                    throw new Error(error.message);
                }

            } catch (error) {
                console.error('Subscription error:', error);
                showError('Failed to process subscription. Please try again.');
                setLoading(false);
            }
        }

        // Check if user has active subscription
        async function checkSubscriptionStatus(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    if (userData.subscription && userData.subscription.status === 'active') {
                        console.log('User has active subscription, redirecting to dashboard');
                        window.location.href = 'dashboard.html';
                        return true;
                    }
                }
                return false;
            } catch (error) {
                console.error('Error checking subscription status:', error);
                return false;
            }
        }

        // Flashcard functionality
        let currentCardIndex = 0;
        let isFlipped = false;
        let autoFlipInterval;
        let isAnimating = false;

        const flashcardData = [
            {
                question: "Transform Your Study Sessions",
                answer: "Genius uses advanced AI to create personalized study guides that adapt to your learning style. Generate unlimited materials for any subject, from complex physics equations to historical timelines, all tailored to your specific courses and exam requirements."
            },
            {
                question: "Master Any Subject with Smart Flashcards",
                answer: "Our AI-powered flashcard system uses spaced repetition algorithms to optimize your memory retention. Create cards from your notes, textbooks, or lectures, and watch as Genius schedules reviews at the perfect intervals to maximize long-term learning."
            },
            {
                question: "Turn Documents into Study Gold",
                answer: "Upload any document - PDFs, lecture notes, research papers - and Genius instantly extracts key concepts, creates summaries, and generates study questions. Perfect for processing dense academic material and transforming it into digestible study content."
            },
            {
                question: "Study Anywhere, Anytime",
                answer: "Your study materials sync instantly across all devices. Start on your laptop, continue on your phone during commute, and finish on your tablet at home. Never lose progress or miss a study opportunity with seamless cloud synchronization."
            },
            {
                question: "Track Your Academic Journey",
                answer: "Get detailed insights into your learning patterns, study habits, and performance trends. See which subjects need more attention, track your improvement over time, and receive personalized recommendations to optimize your study strategy."
            },
            {
                question: "Get Help When You Need It",
                answer: "Stuck on a difficult concept? Our priority support team provides fast, expert assistance. Get personalized help with complex topics, technical issues, or study strategies from our team of academic professionals and AI specialists."
            },
            {
                question: "Your Data, Your Privacy",
                answer: "Enterprise-grade security protects your academic work and personal information. All data is encrypted, stored securely, and never shared. Focus on learning while we handle the technical security details with military-grade protection."
            },
            {
                question: "Collaborate with Classmates",
                answer: "Share study materials, work on group projects, and learn together in real-time. Create shared study groups, collaborate on flashcards, and benefit from collective knowledge while maintaining individual progress tracking."
            },
            {
                question: "Study on Any Device",
                answer: "Whether you're on your phone between classes, tablet in the library, or laptop at home, Genius provides a seamless experience. Our responsive design ensures optimal performance and usability across all screen sizes and operating systems."
            },
            {
                question: "AI That Learns You",
                answer: "Genius doesn't just provide tools - it learns your study patterns, preferred learning methods, and academic goals. The AI adapts its recommendations, adjusts difficulty levels, and personalizes content delivery to maximize your learning efficiency and academic success."
            }
        ];

        function initializeFlashcards() {
            updateFlashcard();
            startAutoFlip();
        }

        function updateFlashcard() {
            const questionElement = document.getElementById('flashcardQuestion');
            const answerElement = document.getElementById('flashcardAnswer');
            const flashcard = document.getElementById('flashcard');
            
            if (questionElement && answerElement && flashcard) {
                // Add drag from bottom animation
                flashcard.classList.add('new-card');
                
                // Reset after animation
                setTimeout(() => {
                    flashcard.classList.remove('new-card');
                }, 800);
                
                questionElement.textContent = flashcardData[currentCardIndex].question;
                answerElement.textContent = flashcardData[currentCardIndex].answer;
                
                // Reset flip state
                isFlipped = false;
                flashcard.classList.remove('flipped');
            }
        }

        function swipeOutCard() {
            const flashcard = document.getElementById('flashcard');
            if (flashcard && !isAnimating) {
                isAnimating = true;
                flashcard.classList.add('swipe-out');
                
                // After swipe animation, update to next card
                setTimeout(() => {
                    flashcard.classList.remove('swipe-out');
                    nextCard();
                    isAnimating = false;
                }, 600);
            }
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            if (flashcard) {
                isFlipped = !isFlipped;
                flashcard.classList.toggle('flipped', isFlipped);
            }
        }

        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % flashcardData.length;
            updateFlashcard();
        }

        function startAutoFlip() {
            // Start the first cycle immediately
            startCardCycle();
            
            // Set up recurring sequence every 6 seconds
            autoFlipInterval = setInterval(() => {
                startCardCycle();
            }, 6000);
        }

        function startCardCycle() {
            // Show question for 3 seconds, then flip to answer
            setTimeout(() => {
                flipCard();
                
                // Show answer for 2 seconds, then swipe out
                setTimeout(() => {
                    swipeOutCard();
                }, 2000);
            }, 3000);
        }

        function stopAutoFlip() {
            if (autoFlipInterval) {
                clearInterval(autoFlipInterval);
            }
        }

        // Set current date
        function setCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                const now = new Date();
                const dateString = now.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                dateElement.textContent = dateString;
            }
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Subscription page loaded');
            
            // Initialize flashcards
            initializeFlashcards();
            
            if (!initFirebase()) {
                return;
            }

            if (!initStripe()) {
                return;
            }

            // Check if user is authenticated
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    console.log('User authenticated:', user.uid);
                    
                    // Check if user already has an active subscription
                    const hasActiveSubscription = await checkSubscriptionStatus(user);
                    if (hasActiveSubscription) {
                        return;
                    }
                } else {
                    console.log('No user authenticated, redirecting to login');
                    window.location.href = 'login.html';
                }
            });

            // Coupon event listeners
            document.getElementById('couponBtn').addEventListener('click', openCouponModal);
            document.getElementById('closeCouponModal').addEventListener('click', closeCouponModal);
            document.getElementById('applyCouponBtn').addEventListener('click', applyCoupon);
            
            // Close modal when clicking outside
            document.getElementById('couponModal').addEventListener('click', (e) => {
                if (e.target.id === 'couponModal') {
                    closeCouponModal();
                }
            });
            
            // Handle Enter key in coupon input
            document.getElementById('couponCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    applyCoupon();
                }
            });
        });
    </script>
</body>
</html>
